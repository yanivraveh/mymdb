{% extends "base.html" %}
{% block title %}{{ movie.title }} · MyMDB{% endblock %}
{% block content %}
<p><a href="/">← Back to Movies</a></p>
<article class="card movie-detail-layout">
    <div class="poster-column">
        {% if movie.poster %}
              <img src="{{ movie.poster.url }}" alt="{{ movie.title }} poster">
            {% endif %}
        </div>
        <div class="details-column">
            <h2>{{ movie.title }} ({{ movie.release_year }})</h2>
            <div class="genres mb-3">
                {% for genre in movie.genres.all %}
                    {{ genre.name }}{% if not forloop.last %} &bull; {% endif %}
                {% endfor %}
            </div>
            <p><strong>Overview:</strong> {{ movie.description }}</p>
            <p><strong>Director:</strong> {{ movie.director.first_name }} {{ movie.director.last_name }}</p>
            <p><strong>Main actors:</strong>
              {% for a in movie.main_actors.all %}
                {{ a.first_name }} {{ a.last_name }}{% if not forloop.last %}, {% endif %}
              {% empty %}—{% endfor %}
            </p>
            {% if average_rating %}
              <p><strong>Average Rating:</strong> <span class="average-rating">{{ average_rating|floatformat:1 }} / 5.0</span></p>
            {% endif %}
        </div>
    </article>

    {% if user.is_authenticated %}
    <div class="user-feedback-section mb-4">
      <h4>Your Feedback</h4>
      
      {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <div class="feedback-layout">
        <div class="card mb-3 review-card">
          <div class="card-body">
            {% if user_review %}
              <h5 class="card-title">Your Review</h5>
              <p style="color: grey;">You have submitted a review for this movie. <br>Thank you for your feedback!</p>
              <p><a href="#review-{{ user_review.id }}">Jump to your review.</a></p>
              
            {% else %}
              <h5 class="card-title">Write a Review</h5>
              <form method="post">
                {% csrf_token %}
                <div class="form-group">
                  <label for="{{ form.title.id_for_label }}">Title <small class="text-muted">({{ form.title.help_text }})</small></label>
                  {{ form.title }}
                </div>
                <div class="form-group mt-2">
                   <label for="{{ form.body.id_for_label }}">{{ form.body.label }}</label>
                   {{ form.body }}
                </div>
                <button type="submit" name="review_submit" value="1" class="btn btn-primary mt-3">Submit Review</button>
              </form>
            {% endif %}
          </div>
        </div>

        <div class="card mb-3 rating-card">
          <div class="card-body">
            <h5 class="card-title">Your Rating</h5>
            <form method="post" class="rating-form" data-user-rating="{{ user_rating.score|default:'0' }}">
                {% csrf_token %}
                <div class="star-rating">
                {% for i in "54321"|make_list %}
                    <button type="submit" name="score" value="{{ i }}" class="star {% if user_rating and user_rating.score >= i|add:0 %}rated{% endif %}">&#9733;</button>
                {% endfor %}
                </div>
            </form>
            {% if user_rating %}
                <span class="rating-text">{{ user_rating.score }}/5</span>
            {% else %}
              <span class="rating-text">N/A</span>
            {% endif %}
          </div>
        </div>

        <div class="card mb-3 distribution-card">
            <div class="card-body">
                <h5 class="card-title" style="text-align: center;">Rating Distribution</h5>
                <div class="rating-poll">
                    {% for score, percentage in distribution_data.items|slice:"::1" %}
                    <div class="poll-row">
                        <div class="poll-label">{{ score }} star</div>
                        <div class="poll-bar-container">
                            <div class="poll-bar" style="--poll-width: {{ percentage }}%;" data-score="{{ score }}"></div>
                        </div>
                        <div class="poll-percentage" data-score="{{ score }}">{{ percentage|floatformat:0 }}%</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
       </div>
     
     {% endif %}

    <div class="reviews-section mt-5">
      <h4>Community Reviews</h4>

      {% if not user.is_authenticated and not reviews %}
        <p><a href="{% url 'accounts:user_login' %}?next={{ request.path }}">Log in</a> to be the first to rate or write a review.</p>
      {% elif not reviews %}
         <p>No reviews yet. Be the first to write one!</p>
      {% endif %}

      {% for review in reviews %}
        <div class="review card mb-3" id="review-{{ review.id }}">
            <div class="card-body">
                <h5 class="card-title">{{ review.title }}</h5>
                <p class="card-text">{{ review.body }}</p>
                <h6 class="card-subtitle text-muted mb-0-force">By {{ review.user.username }} on {{ review.created_at|date:"F d, Y" }}</h6>
            </div>
        </div>
      {% endfor %}
    </div>

    <div class="recommendations-section mt-5">
        <h4>Similar Movies</h4>
        <div id="recommendations-container" class="grid">
            {% for movie in similar_movies %}
                <a class="card" href="{{ movie.get_absolute_url }}">
                    {% if movie.poster %}
                        <img src="{{ movie.poster.url }}" alt="{{ movie.title }} poster">
                    {% endif %}
                    <h3>{{ movie.title }}</h3>
                </a>
            {% empty %}
                <p>No recommendations available at the moment.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Rating Logic ---
    const ratingForm = document.querySelector('.rating-form');
    if (ratingForm) {
        const stars = ratingForm.querySelectorAll('.star');
        stars.forEach(star => {
            star.addEventListener('click', function (e) {
                e.preventDefault();
                const score = this.value;
                const currentRating = ratingForm.dataset.userRating;

                if (score === currentRating) {
                    return; // Do nothing if the rating is the same
                }

                const url = `/movies/{{ movie.pk }}/rate/`;
                const csrfToken = ratingForm.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: `score=${score}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        Toastify({
                            text: data.message,
                            duration: 3000,
                            close: true,
                            gravity: "bottom",
                            position: "center",
                            backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                        }).showToast();

                        // Update the UI
                        ratingForm.dataset.userRating = score; // Update the stored rating
                        document.querySelector('.rating-text').innerText = `${score}/5`;
                        stars.forEach(s => {
                            if (s.value <= score) {
                                s.classList.add('rated');
                            } else {
                                s.classList.remove('rated');
                            }
                        });
                        
                        // Update average rating and distribution
                        if (data.new_average_rating !== undefined) {
                            const avgRatingEl = document.querySelector('.average-rating');
                            if (avgRatingEl) {
                                avgRatingEl.innerText = `${data.new_average_rating} / 5.0`;
                            }
                        }

                        if (data.new_distribution) {
                            for (const [score, percentage] of Object.entries(data.new_distribution)) {
                                const pollBar = document.querySelector(`.poll-bar[data-score='${score}']`);
                                const pollPercentage = document.querySelector(`.poll-percentage[data-score='${score}']`);
                                if (pollBar && pollPercentage) {
                                    pollBar.style.setProperty('--poll-width', `${percentage}%`);
                                    pollPercentage.innerText = `${Math.round(percentage)}%`;
                                }
                            }
                        }

                    } else {
                        Toastify({
                            text: data.message || 'An error occurred.',
                            duration: 3000,
                            close: true,
                            gravity: "bottom",
                            position: "center",
                            backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                        }).showToast();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Toastify({
                        text: 'An unexpected error occurred.',
                        duration: 3000,
                        close: true,
                        gravity: "bottom",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    }).showToast();
                });
            });
        });
    }
});
</script>
{% endblock %}
