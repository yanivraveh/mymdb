{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{% block title %}MyMDB{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- If I want to use bootstrap, I can uncomment this -->
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"> -->
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

</head>
<body>
<header>
  <div class="container header-content">
      <a href="/" class="logo">
          <img src="{% static 'images/mymdb_logo.svg' %}" alt="MyMDB Logo">
      </a>
    <nav>
      <!-- this is the header nav bar -->
    </nav>
    <div>
      {% if user.is_authenticated %}
        Welcome, {{ user.username }} |
        <a href="{% url 'accounts:user_logout' %}">Logout</a>
      {% else %}
        <a href="{% url 'accounts:user_login' %}">Login</a> Â· <a href="{% url 'accounts:user_signup' %}">Sign up</a>
      {% endif %}
    </div>
  </div>
</header>
<main>
    <div class="container">
        {% block content %}{% endblock %}
    </div>
</main>
<footer>
    <div class="container">
        <p>&copy; {% now "Y" %} MyMDB. All rights reserved.</p>
    </div>
</footer>

<!-- AI Chatbot Widget -->

<div class="chat-widget">
    <div class="chat-bubble">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg>
    </div>
    <div class="chat-window">
        <div class="chat-header">
            <h5>MyMDBot</h5>
            <button class="chat-close">&ndash;</button>
        </div>
        <div id="chat-messages" class="chat-messages">
            <div class="message assistant">
              {% if AI_PROVIDER == "bedrock" %}Hello! I am Bedrock. {% else %}Hello! I am Gemini. {% endif %}
              I can help you find movies. Try asking "recommend a comedy" or "find dramas from the 90s".
            </div>
        </div>
        <form id="chat-form" class="chat-form">
            <input type="text" id="chat-input" placeholder="Ask me about movies..." autocomplete="off">
            <button type="submit">&#10148;</button>
        </form>
    </div>
</div> 

<!-- RealTime Multi-User Chat Widget -->

<div id="rtchat-root"
     data-auth="{{ request.user.is_authenticated|yesno:'true,false' }}"
     data-login-url="{% url 'accounts:user_login' %}?next={{ request.get_full_path|urlencode }}">
  <button id="rtchat-launcher" class="rtchat-bubble" aria-label="Open chat">ðŸ’¬</button>
  <div id="rtchat-panel" style="
    position: fixed; right: 86px; bottom: 86px; z-index: 9999;
    width: 380px; height: 520px; display:none; box-shadow:0 10px 30px rgba(0,0,0,.2);
    background:#fff; border-radius:12px; overflow:hidden;">
    <iframe id="rtchat-iframe" data-src="{{ CHAT_IFRAME_SRC }}" title="Chat"
        style="width:100%; height:100%; border:0;"></iframe>
  </div>
</div>

<script>
  (function(){
    const root  = document.getElementById('rtchat-root');
    const btn   = document.getElementById('rtchat-launcher');
    const panel = document.getElementById('rtchat-panel');
    const iframe = document.getElementById('rtchat-iframe');  


    const isAuth  = root.dataset.auth === 'true';
    const loginUrl = root.dataset.loginUrl;

    btn.addEventListener('click', () => {
      if (!isAuth) { 
        // Option A: redirect to login 
        window.location.href = loginUrl; 
        // Option B: show alert
        // alert('Must be logged in to use the multiâ€‘user chat');        
        return; }

      if (!iframe.src) iframe.src = iframe.dataset.src; // lazy load

      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    });
  })();
</script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="{% static 'js/chat.js' %}"></script>
{% block scripts %}{% endblock %}
</body>
</html>
